<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>
        
        Ben Ramey's Blog &middot; Scripture, programming problems, solutions and stories.
        
    </title>

    <link rel="stylesheet" href="/assets/css/styles.css">

    <link rel="apple-touch-icon" sizes="180x180" href="">
    <link rel="icon" type="image/png" sizes="32x32" href="">
    <link rel="icon" type="image/png" sizes="16x16" href="">
    <link rel="manifest" href="">

    <link rel="alternate" type="application/atom+xml" title="Ben Ramey's Blog" href="/atom.xml">

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Home" />
<meta name="author" content="Ben Ramey" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://www.benramey.com/page6/" />
<meta property="og:url" content="https://www.benramey.com/page6/" />
<meta property="og:site_name" content="Ben Rameyâ€™s Blog" />
<link rel="prev" href="https://www.benramey.com/page5" />
<link rel="next" href="https://www.benramey.com/page7" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://www.benramey.com/page6/","author":{"@type":"Person","name":"Ben Ramey"},"headline":"Home","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
    <header>
        <div class="container">
            <div class="d-flex justify-content-between align-item-center">
                <a href="/" class="d-flex justify-content-start align-items-center mr-2" title="Home">
                    <img src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg"
                        alt="Gravatar" />
                    <span class="ml-2">Ben Ramey's Blog</span>
                </a>
                <div class="d-none d-sm-flex flex-column justify-content-around ml-2">
                    <small>Scripture, programming problems, solutions and stories.</small>
                </div>
            </div>
        </div>
    </header>

    <nav class="main">
        <div class="container d-flex justify-content-center">
            
            
            
            
            
            
            
            <a href="/archive/">Archive</a>
            
            
            
            
            
            
            
            <a href="/categories/">Categories</a>
            
            
            
            
            
            
            
            
            
            <a href="/tags/">Tags</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="posts">
    
    <article class="post">
        <h1 class="post-title">
            <a href="/2016/02/25/you-cant-subscribe-to-ievent-with-nservicebus/">
                You Can't Subscribe to IEvent with NServiceBus
            </a>
        </h1>

        <time datetime="2016-02-25T09:56:00-06:00" class="post-date">25 Feb 2016</time>

        <p>The reason you might want to subscribe to <code class="highlighter-rouge">IEvent</code> is pretty straightforward. I
wanted to do it for the simple reason of wanting to be able to choose (based
on configuration) whether I wanted to notify anyone of any event that
could be published on my bus.</p>

<p>In other words, whenever an event of any type was published, I wanted one particular
endpoint to subscribe to that event and then decide whether it should do
anything with it.</p>

<p>I thought the code to do that should be pretty simple.  Since all published
events <em>should</em> implement the <code class="highlighter-rouge">IEvent</code> interface and NServiceBus supports
polymorphism in its message handling, creating a message handler that
implemented <code class="highlighter-rouge">IHandleMessages&lt;IEvent&gt;</code> should be all I should have needed!</p>

<p>I was testing this with only partial success and so I thought it was working.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class EventHandler : IHandleMessages&lt;IEvent&gt;
{
   public void Handle(IEvent message)
   {
     ...
   }
}
</code></pre></div></div>

<h2 id="my-partial-success">My Partial Success</h2>
<p>The reason I had partial success was because I was also <em>explicitly</em> handling
other events in the same endpoint on a special saga I had setup.  So, when
the endpoint started up, it would subscribe to these events.  At first, I only
wanted to send notifications for these events anyway, so it all seemed to be
working.  My special <code class="highlighter-rouge">IEvent</code> would work because the <code class="highlighter-rouge">Saga</code> subscribed this same
endpoint to those few events explicitly.</p>

<h2 id="my-full-failure">My Full Failure</h2>
<p>I realized I had only partially succeeded when I started wanting to send notifications
for other events that were not in that <code class="highlighter-rouge">Saga</code>.  I dug into the issue for a few
hours and finally began to wonder if NServiceBus (or maybe the RabbitMQ transport)
was explicitly ignoring <code class="highlighter-rouge">IEvent</code> when it setup subscriptions.</p>

<p>Sure enough, it does.</p>

<p>To build a list of types to subscribe to, NServiceBus uses the <code class="highlighter-rouge">Conventions</code>
class in the <code class="highlighter-rouge">NServiceBus.Core</code> namespace.  One of the checks that code does
is to filter the list of potential types with the <code class="highlighter-rouge">IsEventType</code> method.  This
method checks if the <code class="highlighter-rouge">Type</code> is in a Particular (NServiceBus) DLL.  See the
code here: <a href="https://github.com/Particular/NServiceBus/blob/e4bc405509e3b9c3fc91e21a56333bb40ac54a60/src/NServiceBus.Core/Conventions.cs#L154">IsEventType</a></p>

<h2 id="my-solution">My Solution</h2>
<p>The solution is simple enough.  Instead of listening to <code class="highlighter-rouge">IEvent</code>, listen
to a custom interface that you implement on all of your events.  This is probably
more close to what you are trying to do anywayâ€“listen to all events that your
system produces.</p>

<p>So, I simply created a marker interface called <code class="highlighter-rouge">ICustomEvent</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public interface ICustomEvent : IEvent { }
</code></pre></div></div>

<p>Then, on all of my bus event classes, instead of implementing <code class="highlighter-rouge">IEvent</code> directly,
I implemented <code class="highlighter-rouge">ICustomEvent</code>.</p>

<p>My handler then looked like this.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class EventHandler : IHandleMessages&lt;ICustomEvent&gt;
{
   public void Handle(ICustomEvent message)
   {
     ...
   }
}
</code></pre></div></div>

<p>Now, the right subscriptions are all set up and my single handler gets
every single event published by my entire bus.</p>

    </article>
    
</div>

<nav class="pagination d-flex justify-content-center">
    
    <a class="pagination-item older" href="/page7">Older</a>
    
    
    <a class="pagination-item newer" href="/page5">Newer</a>
    
</nav>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <small>
                &copy; <time datetime="2020-05-13T09:34:51-05:00">2020</time>. All
                rights reserved.
            </small>
        </div>
    </footer>

    <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-1380501-7', 'auto');
	ga('send', 'pageview');
</script>
</body>

</html>
