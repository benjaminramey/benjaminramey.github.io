<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>
        
        Ben Ramey's Blog &middot; Scripture, programming problems, solutions and stories.
        
    </title>

    <link rel="stylesheet" href="/assets/css/styles.css">

    <link rel="apple-touch-icon" sizes="180x180" href="">
    <link rel="icon" type="image/png" sizes="32x32" href="">
    <link rel="icon" type="image/png" sizes="16x16" href="">
    <link rel="manifest" href="">

    <link rel="alternate" type="application/atom+xml" title="Ben Ramey's Blog" href="/atom.xml">

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Home" />
<meta name="author" content="Ben Ramey" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://www.benramey.com/page3/" />
<meta property="og:url" content="https://www.benramey.com/page3/" />
<meta property="og:site_name" content="Ben Ramey’s Blog" />
<link rel="prev" href="https://www.benramey.com/page2" />
<link rel="next" href="https://www.benramey.com/page4" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://www.benramey.com/page3/","author":{"@type":"Person","name":"Ben Ramey"},"headline":"Home","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
    <header>
        <div class="container">
            <div class="d-flex justify-content-between align-item-center">
                <a href="/" class="d-flex justify-content-start align-items-center mr-2" title="Home">
                    <img src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg"
                        alt="Gravatar" />
                    <span class="ml-2">Ben Ramey's Blog</span>
                </a>
                <div class="d-none d-sm-flex flex-column justify-content-around ml-2">
                    <small>Scripture, programming problems, solutions and stories.</small>
                </div>
            </div>
        </div>
    </header>

    <nav class="main">
        <div class="container d-flex justify-content-center">
            
            
            
            
            
            
            
            <a href="/archive/">Archive</a>
            
            
            
            
            
            
            
            <a href="/categories/">Categories</a>
            
            
            
            
            
            
            
            
            
            <a href="/tags/">Tags</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="posts">
    
    <article class="post">
        <h1 class="post-title">
            <a href="/2016/08/24/castle-windsor-typedfactoryfacility-and-property-injection/">
                Castle.Windsor TypedFactoryFacility and Unexpected Property Injection Behavior
            </a>
        </h1>

        <time datetime="2016-08-24T07:37:00-05:00" class="post-date">24 Aug 2016</time>

        <p>I finally got to the bottom of an issue today that came down to the way Castle.Windsor
does property injection (injecting dependencies into public properties) when
you are also using their TypedFactoryFacility.  It was a tough one to track down, so
I thought I’d put the solution out there for everyone else’s benefit.</p>

<h2 id="the-problem">The Problem</h2>
<p>Here’s what the problem looked like.</p>

<h3 id="the-error-message">The Error Message</h3>
<p>First things first, this is what the symptom looked like:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[ComponentNotFoundException: No component for supporting the service System.Threading.Tasks.Task was found]
   Castle.MicroKernel.DefaultKernel.Castle.MicroKernel.IKernelInternal.Resolve(Type service, IDictionary arguments, IReleasePolicy policy) +120
   Castle.Facilities.TypedFactory.Internal.TypedFactoryInterceptor.Resolve(IInvocation invocation) +147
   Castle.Facilities.TypedFactory.Internal.TypedFactoryInterceptor.Intercept(IInvocation invocation) +123
   Castle.DynamicProxy.AbstractInvocation.Proceed() +448
   Castle.Proxies.Func`2Proxy.Invoke(OAuthMatchEndpointContext arg) +168

   ...</code></pre></figure>

<p>This is actually a pretty standard error when you’re using Castle.Windsor. It usually
means Windsor tried to resolve some dependency but discovered that it was missing a
registration.  Translation: you forgot to register a component or type in your Windsor
setup.  Usually it’s an easy fix; just register your dependency properly.</p>

<p>In this case, however, as you can see, the missing registration was of type
System.Threading.Tasks.Task.  I didn’t have any dependencies on the <code class="highlighter-rouge">Task</code> class and so
I didn’t want to “fix” any Windsor setup to register it.  This wasn’t making sense.</p>

<h3 id="step-one-typedfactoryinterceptor">Step One: TypedFactoryInterceptor?</h3>
<p>The first oddity I noticed was that this error was happening somewhere in the flow
of the TypedFactoryInterceptor.  I could tell where the error was coming from in my
code (from the rest of the stack trace that I didn’t include above).  The problem
was that it had nothing to do with any TypedFactoryFacility.</p>

<p>So, I inspected my registrations a little closer.  I basically had a setup like this.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ChildClass</span> <span class="p">:</span> <span class="n">ParentClass</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">DoSomething</span><span class="p">(</span><span class="n">Options</span> <span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">ParentClass</span> <span class="p">:</span> <span class="n">IInterface</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Options</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">OnDoSomething</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">public</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Options</span><span class="p">,</span> <span class="n">Task</span><span class="p">&gt;</span> <span class="n">OnDoSomethingElse</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">public</span> <span class="k">virtual</span> <span class="n">Task</span> <span class="nf">DoSomething</span><span class="p">(</span><span class="n">Options</span> <span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nf">OnDoSomething</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">virtual</span> <span class="n">Task</span> <span class="nf">DoSomethingElse</span><span class="p">(</span><span class="n">Options</span> <span class="n">options</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">OnDoSomethingElse</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Notice a couple of things.</p>
<ol>
  <li>ParentClass has several virtual methods.  I’m only overriding one.</li>
  <li>ParentClass is setup to allow you to override the virtual methods or to just supply
 it with Funcs.</li>
  <li>The implementation of the virtual methods is to simply call the corresponding Funcs.</li>
</ol>

<h3 id="finding-the-location-of-the-problem">Finding the Location of the Problem</h3>
<p>After lots of testing and debugging, I finally figured out that somehow a FuncProxy
(see line 6 in the error stack trace above) was being injected into all of the
public <code class="highlighter-rouge">Func&lt;,&gt;</code> properties on ParentClass.  Then, when methods were called that
I did not override in my ChildClass, the Func would be called in the ParentClass
and that’s where Windsor was hooking in and eventually causing an error when it
eventually tried to resolve a dependency on <code class="highlighter-rouge">Task</code>.</p>

<h3 id="one-more-clue">One More Clue</h3>
<p>As I mentioned above, the presence of a TypedFactoryInterceptor in the stack trace
was strange to me.  I wasn’t using Windor’s TypedFactoryFacility to register my ChildClass.
So, why was it sticking its nose into my class somehow?</p>

<p>I did some simple debugging and turned off the TypedFactoryFacility in my Windsor setup.
Just like magic,
the error I was seeing went away.  So, my conclusion: somehow TypedFactoryFacility was
inserting itself into my ChildClass registration and injecting <code class="highlighter-rouge">FuncProxy</code>s into the
ParentClass public <code class="highlighter-rouge">Func&lt;,&gt;</code> properties.</p>

<h2 id="the-solution">The Solution</h2>
<p>This looked an aweful lot like property injection to me.  I started searching related to
TypedFactoryFacility and property injection.  I pretty quickly came upon this documentation:
<a href="https://github.com/castleproject/Windsor/blob/master/docs/how-properties-are-injected.md">https://github.com/castleproject/Windsor/blob/master/docs/how-properties-are-injected.md</a>.</p>

<p>That page describes how Windsor does property injection, which I actually thought was
an opt-in feature of Windsor.  In fact, Windsor does it by default, as describe on that page.</p>

<p>Combining this revelation (to me) with the fact that TypedFactoryFacility also allows you
to take a dependency on a simple <code class="highlighter-rouge">Func</code> and turn it into a factory call into your Windsor
container, I concluded that, by turning on the TypedFactoryFacility in Windsor, I was opening
up public properties that had <code class="highlighter-rouge">Func&lt;&gt;</code> types to property injection by Windsor.</p>

<p>Now, I hate property injection, so I was fine with just turning it off completely.  Luckily,
the documentation link above also included instructions how to do it. I’ve included that code
here.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">propInjector</span> <span class="p">=</span> <span class="n">Kernel</span><span class="p">.</span><span class="n">ComponentModelBuilder</span>
                         <span class="p">.</span><span class="n">Contributors</span>
                         <span class="p">.</span><span class="n">OfType</span><span class="p">&lt;</span><span class="n">PropertiesDependenciesModelInspector</span><span class="p">&gt;()</span>
                         <span class="p">.</span><span class="nf">Single</span><span class="p">();</span>
<span class="n">Kernel</span><span class="p">.</span><span class="n">ComponentModelBuilder</span><span class="p">.</span><span class="nf">RemoveContributor</span><span class="p">(</span><span class="n">propInjector</span><span class="p">);</span></code></pre></figure>

<p>I added this code into my Windsor container setup and tried again.  Everything worked just
as expected.</p>

<h2 id="lessons-learned">Lessons Learned</h2>
<p>A couple of quick takeaways:</p>
<ol>
  <li>Windsor does property injection by default.  Check out the documentation link above for
 the criteria it uses to determine when it should or not.</li>
  <li>Using TypedFactoryFacility is fantastic, but turn off property injection if you have
 public <code class="highlighter-rouge">Func&lt;&gt;</code> properties anywhere.</li>
</ol>

    </article>
    
</div>

<nav class="pagination d-flex justify-content-center">
    
    <a class="pagination-item older" href="/page4">Older</a>
    
    
    <a class="pagination-item newer" href="/page2">Newer</a>
    
</nav>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <small>
                &copy; <time datetime="2020-05-14T21:16:11-05:00">2020</time>. All
                rights reserved.
            </small>
        </div>
    </footer>

    <!-- <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-1380501-7', 'auto');
	ga('send', 'pageview');
</script> -->
<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101254860);</script>
<script async src="//static.getclicky.com/js"></script>

</body>

</html>
