{"pageProps":{"tags":["sharepoint"],"categories":["programming"],"title":"SharePoint 2010 401 Unauthorized Error","contentHtml":"<p>There are many, many reasons why SharePoint will throw a 401 error. Most of them are hard to track down and have absolutely no bearing on reality unless you’re a genius. So, your only hope is to track down obscure registry updates (hacks), scour the internet for random things other people have found or just give up. :-)</p>\n<p>I just about pulled my hair out yesterday trying to get to the bottom of a 401 Unauthorized error I kept getting for my anonymous access-enabled web application. I’m not sure why, but I never tried debugging my application to see where the error was actually being thrown. I assumed it was on the IIS level or some SharePoint level, so I never tried debugging.</p>\n<p>So, lesson #1 when getting 401 in SharePoint: debug your application.</p>\n<p>Lesson #2: apparently accessing the DefaultPage property of a PublishingWeb requires elevated privileges. Here was my code:</p>\n<div class=\"remark-highlight\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetDefaultPageUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>PublishingWeb<span class=\"token punctuation\">.</span><span class=\"token function\">IsPublishingWeb</span><span class=\"token punctuation\">(</span>SPContext<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">.</span>Web<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span>Empty<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token class-name\">PublishingWeb</span> web <span class=\"token operator\">=</span> PublishingWeb<span class=\"token punctuation\">.</span><span class=\"token function\">GetPublishingWeb</span><span class=\"token punctuation\">(</span>SPContext<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">.</span>Web<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>web <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span>Empty<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> web<span class=\"token punctuation\">.</span>DefaultPage <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">?</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span>Empty <span class=\"token punctuation\">:</span> web<span class=\"token punctuation\">.</span>DefaultPage<span class=\"token punctuation\">.</span>Url<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>That last line was throwing the 401. So, the solution was to wrap it in an SPSecurity.RunWithElevatedPrivileges call, like this:</p>\n<div class=\"remark-highlight\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetDefaultPageUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> url <span class=\"token operator\">=</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span>Empty<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">SPSite</span> currentSite <span class=\"token operator\">=</span> SPContext<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">.</span>Site<span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">SPWeb</span> currentWeb <span class=\"token operator\">=</span> SPContext<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">.</span>Web<span class=\"token punctuation\">;</span>\n\n  SPSecurity<span class=\"token punctuation\">.</span><span class=\"token function\">RunWithElevatedPrivileges</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// reopen site &#x26; web, otherwise defaultpage will throw an error</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SPSite</span> site <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SPSite</span><span class=\"token punctuation\">(</span>currentSite<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SPWeb</span> web <span class=\"token operator\">=</span> site<span class=\"token punctuation\">.</span><span class=\"token function\">OpenWeb</span><span class=\"token punctuation\">(</span>currentWeb<span class=\"token punctuation\">.</span>ID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>PublishingWeb<span class=\"token punctuation\">.</span><span class=\"token function\">IsPublishingWeb</span><span class=\"token punctuation\">(</span>web<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token class-name\">PublishingWeb</span> pubWeb <span class=\"token operator\">=</span> PublishingWeb<span class=\"token punctuation\">.</span><span class=\"token function\">GetPublishingWeb</span><span class=\"token punctuation\">(</span>web<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>web <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      url <span class=\"token operator\">=</span> pubWeb<span class=\"token punctuation\">.</span>DefaultPage <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">?</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span>Empty <span class=\"token punctuation\">:</span> pubWeb<span class=\"token punctuation\">.</span>DefaultPage<span class=\"token punctuation\">.</span>Url<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Thanks to this post for the answer about re-opening the site and web inside the RunWithElevatedPrivileges code:\n<a href=\"http://henry-chong.com/2010/11/sharepoint-anonymous-access-and-publishing-web-default-page\">http://henry-chong.com/2010/11/sharepoint-anonymous-access-and-publishing-web-default-page</a>.</p>\n","date":"2013-05-23T06:00:00Z","slug":"/2013/05/23/sharepoint-2010-401-unauthorized-error"},"__N_SSG":true}