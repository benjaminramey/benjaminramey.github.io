<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/37b3f20555b3dcfb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/37b3f20555b3dcfb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-e70c6273bfe3f237.js" defer=""></script><script src="/_next/static/chunks/main-4011ba79f13e7457.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ce8c41266b210471.js" defer=""></script><script src="/_next/static/chunks/61-425b38ade8d8eadf.js" defer=""></script><script src="/_next/static/chunks/388-1e496dfd41235e8f.js" defer=""></script><script src="/_next/static/chunks/314-535fae6e035750df.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-f75c9ae4d92bd42c.js" defer=""></script><script src="/_next/static/MZhqNgKc23N7HKJs2Ki5N/_buildManifest.js" defer=""></script><script src="/_next/static/MZhqNgKc23N7HKJs2Ki5N/_ssgManifest.js" defer=""></script><script src="/_next/static/MZhqNgKc23N7HKJs2Ki5N/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><header><div class="container"><div class="d-flex justify-content-between align-item-center"><a class="d-flex justify-content-start align-items-center mr-2" href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2740%27%20height=%2740%27/%3e"/></span><img alt="Gravatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Gravatar" src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span><span class="ml-2">Ben Ramey&#x27;s Blog</span></a><div class="d-none d-sm-flex flex-column justify-content-around ml-2"><small>Scripture, programming problems, solutions and stories.</small></div></div></div></header><nav class="main"><div class="container d-flex justify-content-center"><a href="/archive/">archive</a><a href="/tags/">tags</a><a href="/categories/">categories</a></div></nav><main><div class="container"><article class="post"><h1 class="post-title">You Can&#x27;t Subscribe to IEvent with NServiceBus</h1><div class="post-info d-flex justify-content-start"><time dateTime="2016-02-25T06:00:00Z" class="post-date">Thu Feb 25th, 2016<!-- -->, <!-- -->over 8 years<!-- --> ago</time><nav class="post-tags"><a href="/tags/dotnet/">#<!-- -->dotnet</a><a href="/tags/nservicebus/">#<!-- -->nservicebus</a></nav><nav class="post-categories"><span>posted in:</span><a href="/categories/programming/">programming</a></nav></div><div><p>The reason you might want to subscribe to <code>IEvent</code> is pretty straightforward. I
wanted to do it for the simple reason of wanting to be able to choose (based
on configuration) whether I wanted to notify anyone of any event that
could be published on my bus.</p>
<p>In other words, whenever an event of any type was published, I wanted one particular
endpoint to subscribe to that event and then decide whether it should do
anything with it.</p>
<p>I thought the code to do that should be pretty simple. Since all published
events <em>should</em> implement the <code>IEvent</code> interface and NServiceBus supports
polymorphism in its message handling, creating a message handler that
implemented <code>IHandleMessages&#x3C;IEvent></code> should be all I should have needed!</p>
<p>I was testing this with only partial success and so I thought it was working.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&#x3C;</span>IEvent<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">IEvent</span> message<span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
     <span class="token range operator">..</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>My Partial Success</h2>
<p>The reason I had partial success was because I was also <em>explicitly</em> handling
other events in the same endpoint on a special saga I had setup. So, when
the endpoint started up, it would subscribe to these events. At first, I only
wanted to send notifications for these events anyway, so it all seemed to be
working. My special <code>IEvent</code> would work because the <code>Saga</code> subscribed this same
endpoint to those few events explicitly.</p>
<h2>My Full Failure</h2>
<p>I realized I had only partially succeeded when I started wanting to send notifications
for other events that were not in that <code>Saga</code>. I dug into the issue for a few
hours and finally began to wonder if NServiceBus (or maybe the RabbitMQ transport)
was explicitly ignoring <code>IEvent</code> when it setup subscriptions.</p>
<p>Sure enough, it does.</p>
<p>To build a list of types to subscribe to, NServiceBus uses the <code>Conventions</code>
class in the <code>NServiceBus.Core</code> namespace. One of the checks that code does
is to filter the list of potential types with the <code>IsEventType</code> method. This
method checks if the <code>Type</code> is in a Particular (NServiceBus) DLL. See the
code here: <a href="https://github.com/Particular/NServiceBus/blob/e4bc405509e3b9c3fc91e21a56333bb40ac54a60/src/NServiceBus.Core/Conventions.cs#L154">IsEventType</a></p>
<h2>My Solution</h2>
<p>The solution is simple enough. Instead of listening to <code>IEvent</code>, listen
to a custom interface that you implement on all of your events. This is probably
more close to what you are trying to do anyway--listen to all events that your
system produces.</p>
<p>So, I simply created a marker interface called <code>ICustomEvent</code>.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICustomEvent</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IEvent</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div>
<p>Then, on all of my bus event classes, instead of implementing <code>IEvent</code> directly,
I implemented <code>ICustomEvent</code>.</p>
<p>My handler then looked like this.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&#x3C;</span>ICustomEvent<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">ICustomEvent</span> message<span class="token punctuation">)</span>
   <span class="token punctuation">{</span>
     <span class="token range operator">..</span><span class="token punctuation">.</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Now, the right subscriptions are all set up and my single handler gets
every single event published by my entire bus.</p>
</div></article><section class="comments"><a id="comments-section"><h2>Comments</h2></a><div id="disqus_thread"></div></section></div></main><footer class="footer"><div class="container"><hr/><small>Â© <time dateTime="2024-05-26T00:02:27.690Z">2024</time>. All rights reserved.</small></div><script async="" defer="" data-website-id="b5832ded-a501-4aab-b4ce-ef0373a1a887" src="https://umami.benramey.com/umami.js"></script></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tags":["dotnet","nservicebus"],"categories":["programming"],"title":"You Can't Subscribe to IEvent with NServiceBus","contentHtml":"\u003cp\u003eThe reason you might want to subscribe to \u003ccode\u003eIEvent\u003c/code\u003e is pretty straightforward. I\nwanted to do it for the simple reason of wanting to be able to choose (based\non configuration) whether I wanted to notify anyone of any event that\ncould be published on my bus.\u003c/p\u003e\n\u003cp\u003eIn other words, whenever an event of any type was published, I wanted one particular\nendpoint to subscribe to that event and then decide whether it should do\nanything with it.\u003c/p\u003e\n\u003cp\u003eI thought the code to do that should be pretty simple. Since all published\nevents \u003cem\u003eshould\u003c/em\u003e implement the \u003ccode\u003eIEvent\u003c/code\u003e interface and NServiceBus supports\npolymorphism in its message handling, creating a message handler that\nimplemented \u003ccode\u003eIHandleMessages\u0026#x3C;IEvent\u003e\u003c/code\u003e should be all I should have needed!\u003c/p\u003e\n\u003cp\u003eI was testing this with only partial success and so I thought it was working.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eEventHandler\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eIHandleMessages\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eIEvent\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eIEvent\u003c/span\u003e message\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"token range operator\"\u003e..\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n   \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eMy Partial Success\u003c/h2\u003e\n\u003cp\u003eThe reason I had partial success was because I was also \u003cem\u003eexplicitly\u003c/em\u003e handling\nother events in the same endpoint on a special saga I had setup. So, when\nthe endpoint started up, it would subscribe to these events. At first, I only\nwanted to send notifications for these events anyway, so it all seemed to be\nworking. My special \u003ccode\u003eIEvent\u003c/code\u003e would work because the \u003ccode\u003eSaga\u003c/code\u003e subscribed this same\nendpoint to those few events explicitly.\u003c/p\u003e\n\u003ch2\u003eMy Full Failure\u003c/h2\u003e\n\u003cp\u003eI realized I had only partially succeeded when I started wanting to send notifications\nfor other events that were not in that \u003ccode\u003eSaga\u003c/code\u003e. I dug into the issue for a few\nhours and finally began to wonder if NServiceBus (or maybe the RabbitMQ transport)\nwas explicitly ignoring \u003ccode\u003eIEvent\u003c/code\u003e when it setup subscriptions.\u003c/p\u003e\n\u003cp\u003eSure enough, it does.\u003c/p\u003e\n\u003cp\u003eTo build a list of types to subscribe to, NServiceBus uses the \u003ccode\u003eConventions\u003c/code\u003e\nclass in the \u003ccode\u003eNServiceBus.Core\u003c/code\u003e namespace. One of the checks that code does\nis to filter the list of potential types with the \u003ccode\u003eIsEventType\u003c/code\u003e method. This\nmethod checks if the \u003ccode\u003eType\u003c/code\u003e is in a Particular (NServiceBus) DLL. See the\ncode here: \u003ca href=\"https://github.com/Particular/NServiceBus/blob/e4bc405509e3b9c3fc91e21a56333bb40ac54a60/src/NServiceBus.Core/Conventions.cs#L154\"\u003eIsEventType\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eMy Solution\u003c/h2\u003e\n\u003cp\u003eThe solution is simple enough. Instead of listening to \u003ccode\u003eIEvent\u003c/code\u003e, listen\nto a custom interface that you implement on all of your events. This is probably\nmore close to what you are trying to do anyway--listen to all events that your\nsystem produces.\u003c/p\u003e\n\u003cp\u003eSo, I simply created a marker interface called \u003ccode\u003eICustomEvent\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eICustomEvent\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eIEvent\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThen, on all of my bus event classes, instead of implementing \u003ccode\u003eIEvent\u003c/code\u003e directly,\nI implemented \u003ccode\u003eICustomEvent\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eMy handler then looked like this.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eEventHandler\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eIHandleMessages\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eICustomEvent\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n   \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eICustomEvent\u003c/span\u003e message\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n   \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"token range operator\"\u003e..\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n   \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow, the right subscriptions are all set up and my single handler gets\nevery single event published by my entire bus.\u003c/p\u003e\n","date":"2016-02-25T06:00:00Z","slug":"/2016/02/25/you-cant-subscribe-to-ievent-with-nservicebus"},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["2016","02","25","you-cant-subscribe-to-ievent-with-nservicebus"]},"buildId":"MZhqNgKc23N7HKJs2Ki5N","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>