<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/37b3f20555b3dcfb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/37b3f20555b3dcfb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-e70c6273bfe3f237.js" defer=""></script><script src="/_next/static/chunks/main-4011ba79f13e7457.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ce8c41266b210471.js" defer=""></script><script src="/_next/static/chunks/61-425b38ade8d8eadf.js" defer=""></script><script src="/_next/static/chunks/388-1e496dfd41235e8f.js" defer=""></script><script src="/_next/static/chunks/314-535fae6e035750df.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-f75c9ae4d92bd42c.js" defer=""></script><script src="/_next/static/Tu-R8kPWb98mrrORJ3TqN/_buildManifest.js" defer=""></script><script src="/_next/static/Tu-R8kPWb98mrrORJ3TqN/_ssgManifest.js" defer=""></script><script src="/_next/static/Tu-R8kPWb98mrrORJ3TqN/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><header><div class="container"><div class="d-flex justify-content-between align-item-center"><a class="d-flex justify-content-start align-items-center mr-2" href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2740%27%20height=%2740%27/%3e"/></span><img alt="Gravatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="Gravatar" src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span><span class="ml-2">Ben Ramey&#x27;s Blog</span></a><div class="d-none d-sm-flex flex-column justify-content-around ml-2"><small>Scripture, programming problems, solutions and stories.</small></div></div></div></header><nav class="main"><div class="container d-flex justify-content-center"><a href="/archive/">archive</a><a href="/tags/">tags</a><a href="/categories/">categories</a></div></nav><main><div class="container"><article class="post"><h1 class="post-title">Active Directory Authentication in ASP.NET MVC 5 with Forms Authentication and Group-Based Authorization</h1><div class="post-info d-flex justify-content-start"><time dateTime="2014-10-20T06:00:00Z" class="post-date">Mon Oct 20th, 2014<!-- -->, <!-- -->almost 8 years<!-- --> ago</time><nav class="post-tags"><a href="/tags/mvc/">#<!-- -->mvc</a><a href="/tags/asp-net/">#<!-- -->asp-net</a><a href="/tags/active-directory/">#<!-- -->active-directory</a></nav><nav class="post-categories"><span>posted in:</span><a href="/categories/programming/">programming</a></nav></div><div><p>I know that blog post title is sure a mouth-full, but it describes the whole problem I was trying to solve in a recent project.</p>
<h2>The Project</h2>
<p>Let me outline the project briefly. We were building a report dashboard-type site that will live inside the client's network. The dashboard gives an overview of various, very important information that relates to how the company is performing on a hourly basis. So, the dashboard is only available to a certain group of directors.</p>
<p>To limit the solution to the these directors, authentication and authorization would go through their existing Active Directory setup by putting the authorized users in a special AD group.</p>
<h2>The Problem</h2>
<p>Getting authentication to work was a snap. Microsoft provides the System.Web.Security.ActiveDirectoryMembershipProvider
class to use as your membership provider. Putting an <code>[Authorize]</code> attribute on my action methods or entire controllers was all I needed to get it working (besides, of course, the system.web/authentication web.config updates and a controller to show my login form and handle the submit credentials).</p>
<p>Here's my relevant web.config setup:</p>
<div class="remark-highlight"><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>connectionStrings</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ADConnectionString<span class="token punctuation">"</span></span> <span class="token attr-name">connectionString</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#x3C;ldap connection string here><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>connectionStrings</span><span class="token punctuation">></span></span>
â€¦
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>authentication</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Forms<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>forms</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.AuthCookie<span class="token punctuation">"</span></span> <span class="token attr-name">loginUrl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>~/login<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>authentication</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>membership</span> <span class="token attr-name">defaultProvider</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ADMembershipProvider<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>providers</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>clear</span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ADMembershipProvider<span class="token punctuation">"</span></span>
                 <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>System.Web.Security.ActiveDirectoryMembershipProvider<span class="token punctuation">"</span></span>
                 <span class="token attr-name">connectionStringName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ADConnectionString<span class="token punctuation">"</span></span>
                 <span class="token attr-name">attributeMapUsername</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sAMAccountName<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>providers</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>membership</span><span class="token punctuation">></span></span>
</code></pre></div>
<p>The tough part came when I wanted to limit access to users in that AD group. Microsoft doesn't provide a RoleProvider along with its ActiveDirectoryMembershipProvider. So, what to do?</p>
<p>I tried several methods I found online. Most of them were based on creating my own custom RoleProvider and querying AD to iterate through the user's groups (treating them like roles) and seeing if one of them matched my AD group I was looking for. However, I could never get it to work. Each code example I found eventually gave me this AD error when I iterated through the current user's AD groups:</p>
<div class="remark-highlight"><pre class="language-text"><code class="language-text">The specified directory service attribute or value does not exist.</code></pre></div>
<h2>The Solution</h2>
<p>Eventually, I found a solution online that worked. Instead of setting up a custom RoleProvider, all it involved was creating a custom AuthorizeAttribute for your MVC controllers (or action methods) that checked the user's .IsMemberOf method to see if the member belonged the sought after group (or groups). I don't know why this method does not cause the same AD error as describe above, but I'm glad it doesn't! All I can assume is that it queries AD in a more friendly way.</p>
<p>Here is my custom AuthorizeAttribute:</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeADAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizeAttribute</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> _authenticated<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> _authorized<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Groups <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">HandleUnauthorizedRequest</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationContext</span> filterContext<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">HandleUnauthorizedRequest</span><span class="token punctuation">(</span>filterContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_authenticated <span class="token operator">&#x26;&#x26;</span> <span class="token operator">!</span>_authorized<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            filterContext<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedirectResult</span><span class="token punctuation">(</span><span class="token string">"/error/notauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">AuthorizeCore</span><span class="token punctuation">(</span><span class="token class-name">HttpContextBase</span> httpContext<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _authenticated <span class="token operator">=</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">AuthorizeCore</span><span class="token punctuation">(</span>httpContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_authenticated<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>Groups<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                _authorized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> _authorized<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name"><span class="token keyword">var</span></span> groups <span class="token operator">=</span> Groups<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string character">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> username <span class="token operator">=</span> httpContext<span class="token punctuation">.</span>User<span class="token punctuation">.</span>Identity<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                _authorized <span class="token operator">=</span> LDAPHelper<span class="token punctuation">.</span><span class="token function">UserIsMemberOfGroups</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> _authorized<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token string">"Error attempting to authorize user"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _authorized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> _authorized<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        _authorized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _authorized<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Notice that I also included a little code to distinguish between the user not being authenticated (which the call to base.AuthorizeCore takes care of) and not being authorized. Without the code in HandleUnauthorizedRequest, if the user successfully logs in but is not in the AD group, he just sees the log in screen again which doesn't communicate the problem very well.</p>
<p>The this.Log() code uses a Nuget package called this.Log. The LDAPHelper class is something I wrote. The code is below:</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LDAPHelper</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetLDAPContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Uri</span> ldapUri<span class="token punctuation">;</span>
        <span class="token function">ParseLDAPConnectionString</span><span class="token punctuation">(</span><span class="token keyword">out</span> ldapUri<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> HttpUtility<span class="token punctuation">.</span><span class="token function">UrlDecode</span><span class="token punctuation">(</span>ldapUri<span class="token punctuation">.</span>PathAndQuery<span class="token punctuation">.</span><span class="token function">TrimStart</span><span class="token punctuation">(</span><span class="token string character">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetLDAPHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Uri</span> ldapUri<span class="token punctuation">;</span>
        <span class="token function">ParseLDAPConnectionString</span><span class="token punctuation">(</span><span class="token keyword">out</span> ldapUri<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ldapUri<span class="token punctuation">.</span>Host<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ParseLDAPConnectionString</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Uri</span> ldapUri<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">string</span></span> connString <span class="token operator">=</span> ConfigurationManager<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">[</span><span class="token string">"ADConnectionString"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ConnectionString<span class="token punctuation">;</span>

        <span class="token keyword">return</span> Uri<span class="token punctuation">.</span><span class="token function">TryCreate</span><span class="token punctuation">(</span>connString<span class="token punctuation">,</span> UriKind<span class="token punctuation">.</span>Absolute<span class="token punctuation">,</span> <span class="token keyword">out</span> ldapUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">UserIsMemberOfGroups</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> groups<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* Return true immediately if the authorization is not</span>
<span class="token comment">        locked down to any particular AD group */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>groups <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> groups<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Verify that the user is in the given AD group (if any)</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token function">BuildPrincipalContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> userPrincipal <span class="token operator">=</span> UserPrincipal<span class="token punctuation">.</span><span class="token function">FindByIdentity</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
                IdentityType<span class="token punctuation">.</span>SamAccountName<span class="token punctuation">,</span>
                username<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">group</span> <span class="token keyword">in</span> groups<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userPrincipal<span class="token punctuation">.</span><span class="token function">IsMemberOf</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> IdentityType<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token keyword">group</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">PrincipalContext</span> <span class="token function">BuildPrincipalContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">string</span></span> container <span class="token operator">=</span> LDAPHelper<span class="token punctuation">.</span><span class="token function">GetLDAPContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PrincipalContext</span><span class="token punctuation">(</span>ContextType<span class="token punctuation">.</span>Domain<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>My code is mostly based on example code I found on a very helpful <a href="http://stackoverflow.com/questions/4342271/asp-net-mvc-forms-authorization-with-active-directory-groups/4383502#4383502">StackOverflow post</a>.</p>
<p>To use this code, all you have to do is use your custom AuthorizeAttribute instead of the built-in one. Something like this:</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AuthorizeAD</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Groups<span class="token operator">=</span><span class="token string">"Some AD group name"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
â€¦
<span class="token punctuation">}</span>
</code></pre></div>
</div></article><section class="comments"><a id="comments-section"><h2>Comments</h2></a><div id="disqus_thread"></div></section></div></main><footer class="footer"><div class="container"><hr/><small>Â© <time dateTime="2022-08-24T00:01:56.051Z">2022</time>. All rights reserved.</small></div><script async="" defer="" data-website-id="b5832ded-a501-4aab-b4ce-ef0373a1a887" src="https://umami.benramey.com/umami.js"></script></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"tags":["mvc","asp-net","active-directory"],"categories":["programming"],"title":"Active Directory Authentication in ASP.NET MVC 5 with Forms Authentication and Group-Based Authorization","contentHtml":"\u003cp\u003eI know that blog post title is sure a mouth-full, but it describes the whole problem I was trying to solve in a recent project.\u003c/p\u003e\n\u003ch2\u003eThe Project\u003c/h2\u003e\n\u003cp\u003eLet me outline the project briefly. We were building a report dashboard-type site that will live inside the client's network. The dashboard gives an overview of various, very important information that relates to how the company is performing on a hourly basis. So, the dashboard is only available to a certain group of directors.\u003c/p\u003e\n\u003cp\u003eTo limit the solution to the these directors, authentication and authorization would go through their existing Active Directory setup by putting the authorized users in a special AD group.\u003c/p\u003e\n\u003ch2\u003eThe Problem\u003c/h2\u003e\n\u003cp\u003eGetting authentication to work was a snap. Microsoft provides the System.Web.Security.ActiveDirectoryMembershipProvider\nclass to use as your membership provider. Putting an \u003ccode\u003e[Authorize]\u003c/code\u003e attribute on my action methods or entire controllers was all I needed to get it working (besides, of course, the system.web/authentication web.config updates and a controller to show my login form and handle the submit credentials).\u003c/p\u003e\n\u003cp\u003eHere's my relevant web.config setup:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-xml\"\u003e\u003ccode class=\"language-xml\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003econnectionStrings\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eadd\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ename\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eADConnectionString\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003econnectionString\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u0026#x3C;ldap connection string here\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e/\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003econnectionStrings\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\nâ€¦\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eauthentication\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003emode\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eForms\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eforms\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ename\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e.AuthCookie\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eloginUrl\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e~/login\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e/\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eauthentication\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003emembership\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003edefaultProvider\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eADMembershipProvider\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eproviders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n            \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eclear\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e/\u003e\u003c/span\u003e\u003c/span\u003e\n            \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eadd\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ename\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eADMembershipProvider\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n                 \u003cspan class=\"token attr-name\"\u003etype\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eSystem.Web.Security.ActiveDirectoryMembershipProvider\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n                 \u003cspan class=\"token attr-name\"\u003econnectionStringName\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eADConnectionString\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n                 \u003cspan class=\"token attr-name\"\u003eattributeMapUsername\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003esAMAccountName\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e/\u003e\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eproviders\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003emembership\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe tough part came when I wanted to limit access to users in that AD group. Microsoft doesn't provide a RoleProvider along with its ActiveDirectoryMembershipProvider. So, what to do?\u003c/p\u003e\n\u003cp\u003eI tried several methods I found online. Most of them were based on creating my own custom RoleProvider and querying AD to iterate through the user's groups (treating them like roles) and seeing if one of them matched my AD group I was looking for. However, I could never get it to work. Each code example I found eventually gave me this AD error when I iterated through the current user's AD groups:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-text\"\u003e\u003ccode class=\"language-text\"\u003eThe specified directory service attribute or value does not exist.\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eThe Solution\u003c/h2\u003e\n\u003cp\u003eEventually, I found a solution online that worked. Instead of setting up a custom RoleProvider, all it involved was creating a custom AuthorizeAttribute for your MVC controllers (or action methods) that checked the user's .IsMemberOf method to see if the member belonged the sought after group (or groups). I don't know why this method does not cause the same AD error as describe above, but I'm glad it doesn't! All I can assume is that it queries AD in a more friendly way.\u003c/p\u003e\n\u003cp\u003eHere is my custom AuthorizeAttribute:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eAuthorizeADAttribute\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eAuthorizeAttribute\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003c/span\u003e _authenticated\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003c/span\u003e _authorized\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e Groups \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoverride\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandleUnauthorizedRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eAuthorizationContext\u003c/span\u003e filterContext\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ebase\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandleUnauthorizedRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efilterContext\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_authenticated \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003e_authorized\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            filterContext\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResult \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eRedirectResult\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/error/notauthorized\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoverride\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eAuthorizeCore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eHttpContextBase\u003c/span\u003e httpContext\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        _authenticated \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ebase\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eAuthorizeCore\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttpContext\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e_authenticated\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIsNullOrEmpty\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eGroups\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                _authorized \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e _authorized\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e groups \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Groups\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSplit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string character\"\u003e','\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e username \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e httpContext\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eUser\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eIdentity\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eName\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                _authorized \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e LDAPHelper\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eUserIsMemberOfGroups\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eusername\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e groups\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e _authorized\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Error attempting to authorize user\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                _authorized \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e _authorized\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n        _authorized \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e _authorized\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNotice that I also included a little code to distinguish between the user not being authenticated (which the call to base.AuthorizeCore takes care of) and not being authorized. Without the code in HandleUnauthorizedRequest, if the user successfully logs in but is not in the AD group, he just sees the log in screen again which doesn't communicate the problem very well.\u003c/p\u003e\n\u003cp\u003eThe this.Log() code uses a Nuget package called this.Log. The LDAPHelper class is something I wrote. The code is below:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLDAPHelper\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eGetLDAPContainer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eUri\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eParseLDAPConnectionString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eout\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e HttpUtility\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eUrlDecode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eldapUri\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePathAndQuery\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eTrimStart\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string character\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eGetLDAPHost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eUri\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eParseLDAPConnectionString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eout\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHost\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eParseLDAPConnectionString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eout\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUri\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e connString \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e ConfigurationManager\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eConnectionStrings\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ADConnectionString\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eConnectionString\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e Uri\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eTryCreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econnString\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e UriKind\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAbsolute\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eout\u003c/span\u003e ldapUri\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003ebool\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eUserIsMemberOfGroups\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e username\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e groups\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e/* Return true immediately if the authorization is not\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e        locked down to any particular AD group */\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003egroups \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e groups\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// Verify that the user is in the given AD group (if any)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e context \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eBuildPrincipalContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e userPrincipal \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e UserPrincipal\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFindByIdentity\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtext\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                IdentityType\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSamAccountName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                username\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"token keyword\"\u003eforeach\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003egroup\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e groups\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euserPrincipal\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIsMemberOf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econtext\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e IdentityType\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eName\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003egroup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003ePrincipalContext\u003c/span\u003e \u003cspan class=\"token function\"\u003eBuildPrincipalContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003c/span\u003e container \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e LDAPHelper\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eGetLDAPContainer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003ePrincipalContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eContextType\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDomain\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e container\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eMy code is mostly based on example code I found on a very helpful \u003ca href=\"http://stackoverflow.com/questions/4342271/asp-net-mvc-forms-authorization-with-active-directory-groups/4383502#4383502\"\u003eStackOverflow post\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eTo use this code, all you have to do is use your custom AuthorizeAttribute instead of the built-in one. Something like this:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token attribute\"\u003e\u003cspan class=\"token class-name\"\u003eAuthorizeAD\u003c/span\u003e\u003cspan class=\"token attribute-arguments\"\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eGroups\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Some AD group name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHomeController\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eController\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\nâ€¦\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n","date":"2014-10-20T06:00:00Z","slug":"/2014/10/20/active-directory-authentication-in-asp-net-mvc-5-with-forms-authentication-and-group-based-authorization"},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["2014","10","20","active-directory-authentication-in-asp-net-mvc-5-with-forms-authentication-and-group-based-authorization"]},"buildId":"Tu-R8kPWb98mrrORJ3TqN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>