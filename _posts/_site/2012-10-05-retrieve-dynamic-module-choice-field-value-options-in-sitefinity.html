<p>I am testing out Sitefinity right now for an upcoming project. So far, I really like everything I see. It’s a great CMS and should fit out needs just perfectly (for pretty cheap too).</p>

<p>As with all software though, you will inevitably run into things you can’t do so easily (or, at least, as easily as you think you should be able to). I ran into one of those issues yesterday and finally hacked my way to a solution this morning.</p>

<p>##Problem
My problem was this: how do I retrieve the available options for a Choices field in a dynamic module (built with the Module Builder). Honestly, I’m not sure it really matters. That is, I don’t think Sitefinity validates the value of a Choices field against what is technically a “valid” option. I think I read somewhere that it can store any option. However, I wanted to present a drop-down to users that had values that were essentially controlled by the available choices for this field. Here’s the dialog I’m talking about:</p>

<p><img src="/public/images/2012-10-05-retrieve-dynamic-module-choice-field-value-options-in-sitefinity/choices_dialog.png" alt="Choices field choice options" /></p>

<p>##Solution
Finding a way to retrieve this options through the Sitefinity API (which, in all other respects I’ve investigated so far is really good) was impossible. I started decompiling Sitefinity DLLs to see how it was done and still didn’t really get anywhere. All I could see was the choices being picked up from a config file.</p>

<p>As I read more, I realized this was a bigger clue than I initially thought. The dynamic module information is stored in the App_Data/Sitefinity/Configuration directory in the DynamicModulesConfig.config file. Lo and behold, the options were stored in there–in no less than three places too. Sitefinity has the Config.Get interface for it’s configuration files. However, to get the DynamicModulesConfig.config information, I would have had to call something like Config.Get(). But, the DynamicModulesConfig (in Telerik.Sitefinity.DynamicModules.Configuration) is an internal class. So, I couldn’t do that. I decided upon a “get config file and parse the xml” approach.</p>

<p>Here is my eventual solution. Unless they change the file location or configuration XML structure, it’s pretty safe, albeit a little hacky. I created a simple DynamicModulesHelper class.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DynamicModuleHelper</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DynamicModulesConfigRelativePath</span> <span class="p">=</span>
    <span class="s">"~/App_Data/Sitefinity/Configuration/DynamicModulesConfig.config"</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;[]</span> <span class="nf">GetChoiceFieldOptions</span><span class="p">(</span>
    <span class="kt">string</span> <span class="n">contentType</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">dataFieldName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">XmlNodeList</span> <span class="n">choicesNodes</span> <span class="p">=</span> <span class="nf">GetChoiceNodes</span><span class="p">(</span><span class="n">contentType</span><span class="p">,</span> <span class="n">dataFieldName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">choicesNodes</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;[</span><span class="m">0</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">choices</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="n">XmlNode</span> <span class="n">node</span> <span class="k">in</span> <span class="n">choicesNodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">ParseChoiceElement</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">choices</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ParseChoiceElement</span><span class="p">(</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">choices</span><span class="p">,</span>
    <span class="n">XmlNode</span> <span class="n">node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">node</span><span class="p">.</span><span class="n">Attributes</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">string</span> <span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">;</span>
        <span class="n">key</span> <span class="p">=</span> <span class="k">value</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Attributes</span><span class="p">[</span><span class="s">"text"</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">key</span> <span class="p">=</span> <span class="n">node</span><span class="p">.</span><span class="n">Attributes</span><span class="p">[</span><span class="s">"text"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">Attributes</span><span class="p">[</span><span class="s">"value"</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">value</span> <span class="p">=</span> <span class="n">node</span><span class="p">.</span><span class="n">Attributes</span><span class="p">[</span><span class="s">"value"</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">choices</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">XmlNodeList</span> <span class="nf">GetChoiceNodes</span><span class="p">(</span>
    <span class="kt">string</span> <span class="n">contentType</span><span class="p">,</span>
    <span class="kt">string</span> <span class="n">dataFieldName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">dynamicModulesConfigPath</span> <span class="p">=</span> <span class="n">HttpContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="nf">MapPath</span><span class="p">(</span>
        <span class="n">DynamicModulesConfigRelativePath</span><span class="p">);</span>
        <span class="n">XmlDocument</span> <span class="n">xml</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConfigXmlDocument</span><span class="p">();</span>
        <span class="kt">string</span> <span class="n">xpath</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span>
        <span class="s">"/dynamicModulesConfig/contentViewControls"</span><span class="p">,</span>
        <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"/contentViewControl[@contentType='{0}’]"</span><span class="p">,</span> <span class="n">contentType</span><span class="p">),</span>
        <span class="s">"//view[@displayMode=’Read’]"</span><span class="p">,</span>
        <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"//field[@dataFieldName='{0}’]"</span><span class="p">,</span> <span class="n">dataFieldName</span><span class="p">),</span>
        <span class="s">"/choicesConfig/element"</span>
        <span class="p">);</span>

        <span class="n">xml</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">dynamicModulesConfigPath</span><span class="p">);</span>
        <span class="n">XmlNodeList</span> <span class="n">choicesNodes</span> <span class="p">=</span> <span class="n">xml</span><span class="p">.</span><span class="nf">SelectNodes</span><span class="p">(</span><span class="n">xpath</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">choicesNodes</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>To get the Choices field options, you call the GetChoiceFieldOptions method, passing in the dynamic module’s content type string (like this one: “Telerik.Sitefinity.DynamicTypes.Model.TestModule.TestModule”) and the name of the Choices field (like this: “RandomChoices”). So, my particular call for just a goofy test module I created was this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;[]</span> <span class="n">choices</span> <span class="p">=</span> <span class="n">DynamicModuleHelper</span><span class="p">.</span><span class="nf">GetChoiceFieldOptions</span><span class="p">(</span>
    <span class="s">"Telerik.Sitefinity.DynamicTypes.Model.TestModule.TestModule"</span><span class="p">,</span>
    <span class="s">"RandomChoices"</span><span class="p">);</span></code></pre></figure>

