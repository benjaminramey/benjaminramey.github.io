<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>
        
        OWIN Integration Testing with OAuth Bearer Tokens &middot; Ben Ramey's Blog
        
    </title>

    <link rel="stylesheet" href="/assets/css/styles.css">

    <link rel="apple-touch-icon" sizes="180x180" href="">
    <link rel="icon" type="image/png" sizes="32x32" href="">
    <link rel="icon" type="image/png" sizes="16x16" href="">
    <link rel="manifest" href="">

    <link rel="alternate" type="application/atom+xml" title="Ben Ramey's Blog" href="/atom.xml">

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="OWIN Integration Testing with OAuth Bearer Tokens" />
<meta name="author" content="Ben Ramey" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to generate an OAuth bearer token to use with OWIN integration tests." />
<meta property="og:description" content="How to generate an OAuth bearer token to use with OWIN integration tests." />
<link rel="canonical" href="https://www.benramey.com/2016/04/11/owin-oauth-integration-testing-with-bearer-token/" />
<meta property="og:url" content="https://www.benramey.com/2016/04/11/owin-oauth-integration-testing-with-bearer-token/" />
<meta property="og:site_name" content="Ben Ramey’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-04-11T08:34:00-05:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","dateModified":"2016-04-11T08:34:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.benramey.com/2016/04/11/owin-oauth-integration-testing-with-bearer-token/"},"url":"https://www.benramey.com/2016/04/11/owin-oauth-integration-testing-with-bearer-token/","author":{"@type":"Person","name":"Ben Ramey"},"headline":"OWIN Integration Testing with OAuth Bearer Tokens","description":"How to generate an OAuth bearer token to use with OWIN integration tests.","datePublished":"2016-04-11T08:34:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
    <header>
        <div class="container">
            <div class="d-flex justify-content-between align-item-center">
                <a href="/" class="d-flex justify-content-start align-items-center mr-2" title="Home">
                    <img src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg"
                        alt="Gravatar" />
                    <span class="ml-2">Ben Ramey's Blog</span>
                </a>
                <div class="d-none d-sm-flex flex-column justify-content-around ml-2">
                    <small>Scripture, programming problems, solutions and stories.</small>
                </div>
            </div>
        </div>
    </header>

    <nav class="main">
        <div class="container d-flex justify-content-center">
            
            
            
            
            
            
            
            <a href="/archive/">Archive</a>
            
            
            
            
            
            
            
            <a href="/categories/">Categories</a>
            
            
            
            
            
            
            
            
            
            <a href="/tags/">Tags</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </nav>

    <main>
        <div class="container">
            <article class="post">
    <h1 class="post-title">OWIN Integration Testing with OAuth Bearer Tokens</h1>
    <div class="post-info d-flex justify-content-start">
        <time datetime="2016-04-11T08:34:00-05:00" class="post-date">11 Apr 2016</time>
        <nav class="post-tags">
            
            <a href="/tags/owin">#owin</a>
            
            <a href="/tags/.net">#.net</a>
            
        </nav>
        <nav class="post-categories">
            <span>posted in:</span>
            
            <a href="/categories/programming">programming</a>
            
        </nav>
    </div>
    <h2 id="situation">Situation</h2>
<p>The situation is pretty simple.  We have a project written with Web API 2.2
that we have running with OWIN.  The API requires user authorization.  To
accomplish that, we use the OWIN OAuth libraries.</p>

<p>Upon until recently, the OAuth authorization server (the thing that takes in
the user credentials and issues the token) and the API (the resource server) were
hosted in the same site and web project.</p>

<p>Integration testing was pretty easy at this point.  For the authorized calls,
we simply wrote helper methods that logged a test user in through the authorization
server (hosted along with the API in the OWIN test server), got a bearer token
and then made the integration test calls.</p>

<h2 id="problem">Problem</h2>
<p>When we recently decided to split the authorization server and resource server
code up into two separate code bases (so that they could be hosted separately)
we ran into issues with the authorization and API calls no longer being possible within a
single integration test.  The code to generate the bearer token was now no
longer accessible in the test server for the API integration tests because the authorization
server was now designed to be hosted separately.  We’d have
to somehow generate the bearer token without making a call with the OWIN test
server.</p>

<h2 id="solution">Solution</h2>
<p>The solution is to generate a valid bearer token in your test code and send it
along with your test API call as you would have previous.  How to generate that
valid bearer token though??  It turns out to be easier than I thought.</p>

<p>How you use OWIN’s test server is beyond the scope of this blog post, but
eventually you’ll have some code resembling this:</p>

<p>var server = TestServer.Create<Startup>();</Startup></p>

<p>You’ll have to use a overload of the <code class="highlighter-rouge">Create()</code> method to capture a reference
to the server’s <code class="highlighter-rouge">IDataProtector</code>.  This interface defines what OWIN OAuth will
use to encrypt a <code class="highlighter-rouge">ClaimsIdentity</code> into a valid bearer token.</p>

<p>Update your server creation code like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">  <span class="kt">var</span> <span class="n">dataProtector</span><span class="p">;</span>
  <span class="kt">var</span> <span class="n">server</span> <span class="p">=</span> <span class="n">TestServer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">app</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Startup</span><span class="p">();</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">Configuration</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>

    <span class="n">dataProtector</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">CreateDataProtector</span><span class="p">(</span>
      <span class="k">typeof</span><span class="p">(</span><span class="n">OAuthBearerAuthenticationMiddleware</span><span class="p">).</span><span class="n">Namespace</span><span class="p">,</span>
      <span class="s">"Access_Token"</span><span class="p">,</span> <span class="s">"v1"</span><span class="p">);</span>
  <span class="p">});</span></code></pre></figure>

<p>You have to get the <code class="highlighter-rouge">dataProtector</code> this way because it’s the same way that
the OWIN OAuth libraries get it before trying to decrypt the bearer token.
See the source for the OWIN OAuth code here:
<a href="http://katanaproject.codeplex.com/SourceControl/latest#src/Microsoft.Owin.Security.OAuth/OAuthBearerAuthenticationMiddleware.cs">OAuthBearerAuthenticationMiddleware.cs</a></p>

<p>Once you’ve “captured” the <code class="highlighter-rouge">dataProtector</code>, in your integration test (or in some
helper code, probably) you can generate your <code class="highlighter-rouge">ClaimsIdentity</code> and then your
bearer token with the <code class="highlighter-rouge">dataProtector</code>.</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp">  <span class="c1">// inside an integration test</span>
  <span class="k">using</span> <span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// create your valid identity any way you need to here</span>
    <span class="n">ClaimsIdentity</span> <span class="n">identity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ClaimsIdentity</span><span class="p">(</span><span class="k">new</span> <span class="nf">GenericIdentity</span><span class="p">(</span><span class="s">"username"</span><span class="p">));</span>

    <span class="c1">// these classes are defined in the OWIN OAuth libraries.</span>
    <span class="kt">var</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationProperties</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">ticket</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AuthenticationTicket</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">format</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TicketDataFormat</span><span class="p">(</span><span class="n">dataProtector</span><span class="p">);</span>

    <span class="kt">string</span> <span class="n">bearerToken</span> <span class="p">=</span> <span class="n">format</span><span class="p">.</span><span class="nf">Protect</span><span class="p">(</span><span class="n">ticket</span><span class="p">);</span>

    <span class="c1">// ... call your API through the test server with the bearer token...</span>
    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">CreateRequest</span><span class="p">(</span><span class="s">"/api/someendpoint"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">AddHeader</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer "</span> <span class="p">+</span> <span class="n">bearerToken</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">GetAsync</span><span class="p">()</span>
        <span class="p">.</span><span class="n">Result</span><span class="p">;</span>
  <span class="p">}</span></code></pre></figure>


</article>

<!-- Disqus comments -->

<section class="comments">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = 'https://www.benramey.com/2016/04/11/owin-oauth-integration-testing-with-bearer-token/';
        this.page.identifier = '/2016/04/11/owin-oauth-integration-testing-with-bearer-token';
        this.page.title = 'OWIN Integration Testing with OAuth Bearer Tokens';
    };

    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://fishybusiness.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
</section>



<section class="related">
    <h2>Related posts</h2>
    <ul class="related-posts">
        
        <li>
            <a href="/2020/05/12/psalm-130/">
                Psalm 130
                <small><time
                        datetime="2020-05-12T00:00:00-05:00">12 May 2020</time></small>
            </a>
        </li>
        
        <li>
            <a href="/2017/01/20/I-Like-Languages-That-Expect-Me-To-Be-a-Great-Programmer/">
                I Like Languages That Expect Me To Be a Great Programmer
                <small><time
                        datetime="2017-01-20T14:05:00-06:00">20 Jan 2017</time></small>
            </a>
        </li>
        
        <li>
            <a href="/2016/08/24/castle-windsor-typedfactoryfacility-and-property-injection/">
                Castle.Windsor TypedFactoryFacility and Unexpected Property Injection Behavior
                <small><time
                        datetime="2016-08-24T07:37:00-05:00">24 Aug 2016</time></small>
            </a>
        </li>
        
    </ul>
    </aside>
    

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <small>
                &copy; <time datetime="2020-05-14T10:25:51-05:00">2020</time>. All
                rights reserved.
            </small>
        </div>
    </footer>

    <!-- <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-1380501-7', 'auto');
	ga('send', 'pageview');
</script> -->
<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101254860);</script>
<script async src="//static.getclicky.com/js"></script>

</body>

</html>
