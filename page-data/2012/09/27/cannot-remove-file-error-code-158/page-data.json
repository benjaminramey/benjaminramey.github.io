{"componentChunkName":"component---src-templates-post-js","path":"/2012/09/27/cannot-remove-file-error-code-158/","result":{"data":{"markdownRemark":{"html":"<p>  UPDATE (9/19/2013):\nPlease see Jeff’s comment below for a better solution to this issue using best-practices for iterating through a SPSite’s AllWebs collection.\nThere are multiple places online that provide an answer to the error in the title of this post. The scenario is pretty simple: deleting a master page file previously deployed by a feature in the FeatureDeactivating method of a FeatureReceiver.</p>\n<p>Posts like this one <a href=\"http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation\">http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation</a> give the right answer (even if it’s sloppy–you don’t need to loop through EACH SPWeb and try to delete the files) but you can still get the error if you’re not careful (like I wasn’t!).</p>\n<p>Here was my specific case. In my FeatureDeactivating method I was setting all the SPWebs back to the original v4.master like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"highlight-csharp\"><code class=\"highlight-csharp\"><span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SPWeb</span> site <span class=\"token keyword\">in</span> siteColl<span class=\"token punctuation\">.</span>AllWebs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  site<span class=\"token punctuation\">.</span>MasterUrl <span class=\"token operator\">=</span> masterUrl<span class=\"token punctuation\">;</span>\n  site<span class=\"token punctuation\">.</span>CustomMasterUrl <span class=\"token operator\">=</span> masterUrl<span class=\"token punctuation\">;</span>\n  site<span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice how I am looping through the SPSite.AllWebs SPWebCollection and updating each SPWeb after I reset the master page URLs. Now, here is what I was doing to try to delete the master page file from the _catalogs/masterpage library:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"highlight-csharp\"><code class=\"highlight-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fileUrl <span class=\"token operator\">=</span> SPUrlUtility<span class=\"token punctuation\">.</span><span class=\"token function\">CombineUrl</span><span class=\"token punctuation\">(</span>\n  siteColl<span class=\"token punctuation\">.</span>ServerRelativeUrl<span class=\"token punctuation\">,</span>\n  file<span class=\"token punctuation\">.</span>FullRelativeUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">SPFile</span> spFile <span class=\"token operator\">=</span> siteColl<span class=\"token punctuation\">.</span>RootWeb<span class=\"token punctuation\">.</span><span class=\"token function\">GetFile</span><span class=\"token punctuation\">(</span>fileUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>spFile<span class=\"token punctuation\">.</span>Exists<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    spFile<span class=\"token punctuation\">.</span><span class=\"token function\">Delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    spFile<span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>When I would get to the spFile.Delete() line, it would catch the exception whose error message is the title of this post. But why?? The master page wasn’t being referenced anywhere anymore! As I would discover, the problem is on this line:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"highlight-csharp\"><code class=\"highlight-csharp\"><span class=\"token class-name\">SPFile</span> spFile <span class=\"token operator\">=</span> siteColl<span class=\"token punctuation\">.</span>RootWeb<span class=\"token punctuation\">.</span><span class=\"token function\">GetFile</span><span class=\"token punctuation\">(</span>fileUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Do you see it? I didn’t at first either. The RootWeb SPWeb reference isn’t pointing to the same object that the same SPWeb in the SPSite.AllWebs collection is pointing to. So, technically, the RootWeb object still thinks its master page URLs are pointing to my custom master that I’m trying to delete because it hasn’t had Update() called on it.</p>\n<p>To fix it, I had to get my SPFile from one of the SPWebs in SPSite.AllWebs, like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"highlight-csharp\"><code class=\"highlight-csharp\"><span class=\"token class-name\">SPFile</span> spFile <span class=\"token operator\">=</span> siteColl<span class=\"token punctuation\">.</span>AllWebs<span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetFile</span><span class=\"token punctuation\">(</span>fileUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>That enables me to delete the file with no errors.</p>\n<h2>Jeff's comment</h2>\n<p>Hi Ben,\nGreat post but I did run into the same issue you were experiencing today. You can fix this issue also by using recommended best practice (<a href=\"http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx\">http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx</a>) –</p>\n<p>Good Coding Practice #2</p>\n<p>When iterating through SPWebs dispose of items with the using statement. This will cleanup any issues left in memory</p>\n<p>So it might look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"highlight-csharp\"><code class=\"highlight-csharp\"><span class=\"token keyword\">using</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SPSite</span> siteColl <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">.</span>Feature<span class=\"token punctuation\">.</span>Parent <span class=\"token keyword\">as</span> <span class=\"token class-name\">SPSite</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SPWeb</span> site <span class=\"token keyword\">in</span> siteColl<span class=\"token punctuation\">.</span>AllWebs<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    site<span class=\"token punctuation\">.</span>MasterUrl <span class=\"token operator\">=</span> masterUrl<span class=\"token punctuation\">;</span> site<span class=\"token punctuation\">.</span>CustomMasterUrl <span class=\"token operator\">=</span> masterUrl<span class=\"token punctuation\">;</span> site<span class=\"token punctuation\">.</span><span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug":"/2012/09/27/cannot-remove-file-error-code-158/"},"frontmatter":{"title":"Cannot remove file “master_page_name_here”. Error Code: 158","formattedDate":"Thu Sep 27th 2012","isoDate":"2012-09-27T00:00:00.000Z","fromNowDate":"9 years ago","categories":["programming"],"tags":["sharepoint"]}},"site":{"siteMetadata":{"title":"Ben Ramey's Blog","tagline":"Scripture, programming problems, solutions and stories."}},"sitePage":{"path":"/dev-404-page/"}},"pageContext":{"slug":"/2012/09/27/cannot-remove-file-error-code-158/"}},"staticQueryHashes":[]}