<p>There are many, many reasons why SharePoint will throw a 401 error.  Most of them are hard to track down and have absolutely no bearing on reality unless you’re a genius.  So, your only hope is to track down obscure registry updates (hacks), scour the internet for random things other people have found or just give up.  :-)</p>

<p>I just about pulled my hair out yesterday trying to get to the bottom of a 401 Unauthorized error I kept getting for my anonymous access-enabled web application.  I’m not sure why, but I never tried debugging my application to see where the error was actually being thrown.  I assumed it was on the IIS level or some SharePoint level, so I never tried debugging.</p>

<p>So, lesson #1 when getting 401 in SharePoint: debug your application.</p>

<p>Lesson #2: apparently accessing the DefaultPage property of a PublishingWeb requires elevated privileges.  Here was my code:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="kt">string</span> <span class="nf">GetDefaultPageUrl</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(!</span><span class="n">PublishingWeb</span><span class="p">.</span><span class="nf">IsPublishingWeb</span><span class="p">(</span><span class="n">SPContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Web</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">PublishingWeb</span> <span class="n">web</span> <span class="p">=</span> <span class="n">PublishingWeb</span><span class="p">.</span><span class="nf">GetPublishingWeb</span><span class="p">(</span><span class="n">SPContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Web</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">web</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">web</span><span class="p">.</span><span class="n">DefaultPage</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span> <span class="p">:</span> <span class="n">web</span><span class="p">.</span><span class="n">DefaultPage</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>That last line was throwing the 401. So, the solution was to wrap it in an SPSecurity.RunWithElevatedPrivileges call, like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="kt">string</span> <span class="nf">GetDefaultPageUrl</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
  <span class="n">SPSite</span> <span class="n">currentSite</span> <span class="p">=</span> <span class="n">SPContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Site</span><span class="p">;</span>
  <span class="n">SPWeb</span> <span class="n">currentWeb</span> <span class="p">=</span> <span class="n">SPContext</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Web</span><span class="p">;</span>

  <span class="n">SPSecurity</span><span class="p">.</span><span class="nf">RunWithElevatedPrivileges</span><span class="p">(</span>
  <span class="p">()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="c1">// reopen site &amp; web, otherwise defaultpage will throw an error</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">SPSite</span> <span class="n">site</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SPSite</span><span class="p">(</span><span class="n">currentSite</span><span class="p">.</span><span class="n">ID</span><span class="p">))</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">web</span> <span class="p">=</span> <span class="n">site</span><span class="p">.</span><span class="nf">OpenWeb</span><span class="p">(</span><span class="n">currentWeb</span><span class="p">.</span><span class="n">ID</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(!</span><span class="n">PublishingWeb</span><span class="p">.</span><span class="nf">IsPublishingWeb</span><span class="p">(</span><span class="n">web</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">PublishingWeb</span> <span class="n">pubWeb</span> <span class="p">=</span> <span class="n">PublishingWeb</span><span class="p">.</span><span class="nf">GetPublishingWeb</span><span class="p">(</span><span class="n">web</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">web</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">url</span> <span class="p">=</span> <span class="n">pubWeb</span><span class="p">.</span><span class="n">DefaultPage</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span> <span class="p">:</span> <span class="n">pubWeb</span><span class="p">.</span><span class="n">DefaultPage</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="n">url</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Thanks to this post for the answer about re-opening the site and web inside the RunWithElevatedPrivileges code:
<a href="http://henry-chong.com/2010/11/sharepoint-anonymous-access-and-publishing-web-default-page">http://henry-chong.com/2010/11/sharepoint-anonymous-access-and-publishing-web-default-page</a>.</p>
