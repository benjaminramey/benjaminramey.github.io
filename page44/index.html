<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>
        
        Ben Ramey's Blog &middot; Scripture, programming problems, solutions and stories.
        
    </title>

    <link rel="stylesheet" href="/assets/css/styles.css">

    <link rel="apple-touch-icon" sizes="180x180" href="">
    <link rel="icon" type="image/png" sizes="32x32" href="">
    <link rel="icon" type="image/png" sizes="16x16" href="">
    <link rel="manifest" href="">

    <link rel="alternate" type="application/atom+xml" title="Ben Ramey's Blog" href="/atom.xml">

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Home" />
<meta name="author" content="Ben Ramey" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="https://www.benramey.com/page44/" />
<meta property="og:url" content="https://www.benramey.com/page44/" />
<meta property="og:site_name" content="Ben Ramey’s Blog" />
<link rel="prev" href="https://www.benramey.com/page43" />
<link rel="next" href="https://www.benramey.com/page45" />
<script type="application/ld+json">
{"@type":"WebPage","url":"https://www.benramey.com/page44/","author":{"@type":"Person","name":"Ben Ramey"},"headline":"Home","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>
    <header>
        <div class="container">
            <div class="d-flex justify-content-between align-item-center">
                <a href="/" class="d-flex justify-content-start align-items-center mr-2" title="Home">
                    <img src="https://en.gravatar.com/userimage/738990/32d8e61848233a67f5e02dcc43be0ff8.jpeg"
                        alt="Gravatar" />
                    <span class="ml-2">Ben Ramey's Blog</span>
                </a>
                <div class="d-none d-sm-flex flex-column justify-content-around ml-2">
                    <small>Scripture, programming problems, solutions and stories.</small>
                </div>
            </div>
        </div>
    </header>

    <nav class="main">
        <div class="container d-flex justify-content-center">
            
            
            
            
            
            
            
            <a href="/archive/">Archive</a>
            
            
            
            
            
            
            
            <a href="/categories/">Categories</a>
            
            
            
            
            
            
            
            
            
            <a href="/tags/">Tags</a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="posts">
    
    <article class="post">
        <h1 class="post-title">
            <a href="/2012/09/27/cannot-remove-file-error-code-158/">
                Cannot remove file “master_page_name_here”. Error Code: 158
            </a>
        </h1>

        <div class="post-info d-flex justify-content-start">
            <time datetime="2012-09-27T00:00:00-05:00" class="post-date">27 Sep 2012</time>
            <nav class="post-tags">
                
                <a href="/tags/sharepoint">#sharepoint</a>
                
            </nav>
            <nav class="post-categories">
                <span>posted in:</span>
                
                <a href="/categories/programming">programming</a>
                
            </nav>
        </div>

        <p>UPDATE (9/19/2013):
  Please see Jeff’s comment below for a better solution to this issue using best-practices for iterating through a SPSite’s AllWebs collection.
  There are multiple places online that provide an answer to the error in the title of this post. The scenario is pretty simple: deleting a master page file previously deployed by a feature in the FeatureDeactivating method of a FeatureReceiver.</p>

<p>Posts like this one <a href="http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation">http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation</a> give the right answer (even if it’s sloppy–you don’t need to loop through EACH SPWeb and try to delete the files) but you can still get the error if you’re not careful (like I wasn’t!).</p>

<p>Here was my specific case. In my FeatureDeactivating method I was setting all the SPWebs back to the original v4.master like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">foreach</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">site</span> <span class="k">in</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">site</span><span class="p">.</span><span class="n">MasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span>
  <span class="n">site</span><span class="p">.</span><span class="n">CustomMasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span>
  <span class="n">site</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Notice how I am looping through the SPSite.AllWebs SPWebCollection and updating each SPWeb after I reset the master page URLs. Now, here is what I was doing to try to delete the master page file from the _catalogs/masterpage library:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">string</span> <span class="n">fileUrl</span> <span class="p">=</span> <span class="n">SPUrlUtility</span><span class="p">.</span><span class="nf">CombineUrl</span><span class="p">(</span>
  <span class="n">siteColl</span><span class="p">.</span><span class="n">ServerRelativeUrl</span><span class="p">,</span>
  <span class="n">file</span><span class="p">.</span><span class="n">FullRelativeUrl</span><span class="p">);</span>
<span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">.</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span>
<span class="k">try</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spFile</span><span class="p">.</span><span class="n">Exists</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">spFile</span><span class="p">.</span><span class="nf">Delete</span><span class="p">();</span>
    <span class="n">spFile</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">{</span> <span class="p">}</span></code></pre></figure>

<p>When I would get to the spFile.Delete() line, it would catch the exception whose error message is the title of this post. But why?? The master page wasn’t being referenced anywhere anymore! As I would discover, the problem is on this line:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">.</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span></code></pre></figure>

<p>Do you see it? I didn’t at first either. The RootWeb SPWeb reference isn’t pointing to the same object that the same SPWeb in the SPSite.AllWebs collection is pointing to. So, technically, the RootWeb object still thinks its master page URLs are pointing to my custom master that I’m trying to delete because it hasn’t had Update() called on it.</p>

<p>To fix it, I had to get my SPFile from one of the SPWebs in SPSite.AllWebs, like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span></code></pre></figure>

<p>That enables me to delete the file with no errors.</p>

<h2 id="jeffs-comment">Jeff’s comment</h2>
<p>Hi Ben,
Great post but I did run into the same issue you were experiencing today. You can fix this issue also by using recommended best practice (<a href="http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx">http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx</a>) –</p>

<p>Good Coding Practice #2</p>

<p>When iterating through SPWebs dispose of items with the using statement. This will cleanup any issues left in memory</p>

<p>So it might look like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span><span class="p">(</span><span class="n">SPSite</span> <span class="n">siteColl</span> <span class="p">=</span> <span class="n">properties</span><span class="p">.</span><span class="n">Feature</span><span class="p">.</span><span class="n">Parent</span> <span class="k">as</span> <span class="n">SPSite</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">site</span> <span class="k">in</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">site</span><span class="p">.</span><span class="n">MasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span> <span class="n">site</span><span class="p">.</span><span class="n">CustomMasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span> <span class="n">site</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>



    </article>

    <section>
        <a href="/2012/09/27/cannot-remove-file-error-code-158/#comments-section">
            See comments
        </a>
    </section>
    
</div>

<nav class="pagination d-flex justify-content-center">
    
    <a class="pagination-item older" href="/page45">Older</a>
    
    
    <a class="pagination-item newer" href="/page43">Newer</a>
    
</nav>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <small>
                &copy; <time datetime="2020-05-27T14:48:33-05:00">2020</time>. All
                rights reserved.
            </small>
        </div>
    </footer>

    <!-- <script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-1380501-7', 'auto');
	ga('send', 'pageview');
</script> -->
<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101254860);</script>
<script async src="//static.getclicky.com/js"></script>

</body>

</html>
