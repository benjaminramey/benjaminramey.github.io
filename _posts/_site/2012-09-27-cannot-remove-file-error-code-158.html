<p>UPDATE (9/19/2013):
  Please see Jeff’s comment below for a better solution to this issue using best-practices for iterating through a SPSite’s AllWebs collection.
  There are multiple places online that provide an answer to the error in the title of this post. The scenario is pretty simple: deleting a master page file previously deployed by a feature in the FeatureDeactivating method of a FeatureReceiver.</p>

<p>Posts like this one <a href="http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation">http://sharepoint.stackexchange.com/questions/41358/delete-custom-master-page-error-on-feature-deactivation</a> give the right answer (even if it’s sloppy–you don’t need to loop through EACH SPWeb and try to delete the files) but you can still get the error if you’re not careful (like I wasn’t!).</p>

<p>Here was my specific case. In my FeatureDeactivating method I was setting all the SPWebs back to the original v4.master like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">foreach</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">site</span> <span class="k">in</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">site</span><span class="p">.</span><span class="n">MasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span>
  <span class="n">site</span><span class="p">.</span><span class="n">CustomMasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span>
  <span class="n">site</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Notice how I am looping through the SPSite.AllWebs SPWebCollection and updating each SPWeb after I reset the master page URLs. Now, here is what I was doing to try to delete the master page file from the _catalogs/masterpage library:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">string</span> <span class="n">fileUrl</span> <span class="p">=</span> <span class="n">SPUrlUtility</span><span class="p">.</span><span class="nf">CombineUrl</span><span class="p">(</span>
  <span class="n">siteColl</span><span class="p">.</span><span class="n">ServerRelativeUrl</span><span class="p">,</span>
  <span class="n">file</span><span class="p">.</span><span class="n">FullRelativeUrl</span><span class="p">);</span>
<span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">.</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span>
<span class="k">try</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spFile</span><span class="p">.</span><span class="n">Exists</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">spFile</span><span class="p">.</span><span class="nf">Delete</span><span class="p">();</span>
    <span class="n">spFile</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">{</span> <span class="p">}</span></code></pre></figure>

<p>When I would get to the spFile.Delete() line, it would catch the exception whose error message is the title of this post. But why?? The master page wasn’t being referenced anywhere anymore! As I would discover, the problem is on this line:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">.</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span></code></pre></figure>

<p>Do you see it? I didn’t at first either. The RootWeb SPWeb reference isn’t pointing to the same object that the same SPWeb in the SPSite.AllWebs collection is pointing to. So, technically, the RootWeb object still thinks its master page URLs are pointing to my custom master that I’m trying to delete because it hasn’t had Update() called on it.</p>

<p>To fix it, I had to get my SPFile from one of the SPWebs in SPSite.AllWebs, like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">SPFile</span> <span class="n">spFile</span> <span class="p">=</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="nf">GetFile</span><span class="p">(</span><span class="n">fileUrl</span><span class="p">);</span></code></pre></figure>

<p>That enables me to delete the file with no errors.</p>

<h2 id="jeffs-comment">Jeff’s comment</h2>
<p>Hi Ben,
Great post but I did run into the same issue you were experiencing today. You can fix this issue also by using recommended best practice (<a href="http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx">http://msdn.microsoft.com/en-us/library/aa973248(v=office.12).aspx</a>) –</p>

<p>Good Coding Practice #2</p>

<p>When iterating through SPWebs dispose of items with the using statement. This will cleanup any issues left in memory</p>

<p>So it might look like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span><span class="p">(</span><span class="n">SPSite</span> <span class="n">siteColl</span> <span class="p">=</span> <span class="n">properties</span><span class="p">.</span><span class="n">Feature</span><span class="p">.</span><span class="n">Parent</span> <span class="k">as</span> <span class="n">SPSite</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">site</span> <span class="k">in</span> <span class="n">siteColl</span><span class="p">.</span><span class="n">AllWebs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">site</span><span class="p">.</span><span class="n">MasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span> <span class="n">site</span><span class="p">.</span><span class="n">CustomMasterUrl</span> <span class="p">=</span> <span class="n">masterUrl</span><span class="p">;</span> <span class="n">site</span><span class="p">.</span><span class="nf">Update</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

